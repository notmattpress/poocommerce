/**
 * External dependencies
 */
const path = require( 'path' );
const DependencyExtractionWebpackPlugin = require( '@wordpress/dependency-extraction-webpack-plugin' );
const MiniCssExtractPlugin = require( 'mini-css-extract-plugin' );
const WebpackRTLPlugin = require( './webpack-rtl-plugin' );
const [
	,
	moduleConfig,
] = require( '@wordpress/scripts/config/webpack.config' );
const RemoveFilesPlugin = require( './remove-files-webpack-plugin' );

/**
 * Internal dependencies
 */
const { sharedOptimizationConfig } = require( './webpack-shared-config' );
const {
	scriptModuleEntries,
	styleEntries,
	editorStyleEntries,
} = require( './webpack-interactivity-entries' );

const entries = {
	// Blocks
	...scriptModuleEntries,
	...styleEntries,
	...editorStyleEntries,

	// Experimental mini cart frontend modules, only enqueued when experimental-iapi-mini-cart feature flag is enabled.
	'poocommerce/mini-cart': './assets/js/blocks/mini-cart/iapi-frontend.ts',

	// Product elements frontend module. Share by several blocks.
	'poocommerce/product-elements':
		'./assets/js/atomic/blocks/product-elements/frontend.ts',
	// Add to cart with options quantity selector frontend module used by the
	// Product Quantity block and the Grouped Product Selector block.
	'poocommerce/add-to-cart-with-options-quantity-selector':
		'./assets/js/blocks/add-to-cart-with-options/quantity-selector/frontend.ts',

	// Other
	'@poocommerce/stores/poocommerce/cart':
		'./assets/js/base/stores/poocommerce/cart.ts',
	'@poocommerce/stores/store-notices':
		'./assets/js/base/stores/store-notices.ts',
	'@poocommerce/stores/poocommerce/product-data':
		'./assets/js/base/stores/poocommerce/product-data.ts',
};

module.exports = {
	entry: entries,
	optimization: sharedOptimizationConfig,
	name: 'interactivity-blocks-modules',
	experiments: {
		outputModule: true,
	},
	output: {
		devtoolNamespace: 'wc',
		filename: '[name].js',
		library: {
			type: 'module',
		},
		path: path.resolve( __dirname, '../build/' ),
		asyncChunks: false,
		chunkFormat: 'module',
		environment: { module: true },
		module: true,
	},
	resolve: {
		extensions: [ '.js', '.ts', '.tsx' ],
	},
	plugins: [
		new MiniCssExtractPlugin( {
			filename: '[name].css',
		} ),
		new DependencyExtractionWebpackPlugin( {
			combineAssets: true,
			combinedOutputFile: './interactivity-blocks-frontend-assets.php',
			requestToExternalModule( request ) {
				if (
					request.startsWith( '@poocommerce/stores/poocommerce/' )
				) {
					return `module ${ request }`;
				} else if ( request.startsWith( '@poocommerce/stores/' ) ) {
					return `import ${ request }`;
				}
			},
		} ),
		new WebpackRTLPlugin( {
			filenameSuffix: '-rtl.css',
		} ),
		// Remove JS files generated by MiniCssExtractPlugin.
		new RemoveFilesPlugin( './build/**/*-@(editor|style).js' ),
	],
	module: {
		rules: [
			...moduleConfig.module.rules.filter(
				( rule ) =>
					! rule.test.test( '.css' ) &&
					! rule.test.test( '.scss' ) &&
					! rule.test.test( '.sass' )
			),
			{
				test: /\.s?css$/,
				use: [
					MiniCssExtractPlugin.loader,
					'css-loader',
					'postcss-loader',
					{
						loader: 'sass-loader',
						options: {
							sassOptions: {
								includePaths: [ 'assets/css/abstracts' ],
							},
							additionalData: ( content, loaderContext ) => {
								const { resourcePath, rootContext } =
									loaderContext;
								const relativePath = path.relative(
									rootContext,
									resourcePath
								);

								if (
									relativePath.startsWith(
										'assets/css/abstracts/'
									) ||
									relativePath.startsWith(
										'assets\\css\\abstracts\\'
									)
								) {
									return content;
								}

								return (
									'@use "sass:math";' +
									'@use "sass:string";' +
									'@use "sass:color";' +
									'@use "sass:map";' +
									'@import "_colors"; ' +
									'@import "_variables"; ' +
									'@import "_breakpoints"; ' +
									'@import "_mixins"; ' +
									content
								);
							},
						},
					},
				],
			},
		],
	},
};
